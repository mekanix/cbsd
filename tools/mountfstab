#!/usr/local/bin/cbsd
#v12.0.4
MYARG="jroot fstab"
MYOPTARG="jname"
MYDESC="Mount jail by fstab file"
ADDHELP="jroot - root of jail, fstab - fstab file\n"

. ${subr}

. ${cbsdinit}

. ${system}

[ ! -f "${fstab}" ] && err 1 "${fstab} does not exist"
[ ! -d "${jroot}" ] && err 1 "${jroot} does not exist"

# local fstab exist ?
have_local=0

# special sign for zfs attach
with_zfs_attach="${jailsysdir}/${jname}/with_zfs_attach"

init_localmpt_fstab()
{
	local _ret=
	[ ! -f "${fstab}.local" ] && return 0

	have_local=1

	local i=0

	# check for CRLF at the end of file
	_ret=$( /usr/bin/tail -n1 "${fstab}.local" )

	if [ -n "${_ret}" ]; then
		# append CRLF for proper while read loop
		printf '\n' >> "${fstab}.local"
	fi

	# always rewrite CBSDROOT first
	replacewdir file0="${fstab}.local" old="CBSDROOT"

	eval $( /bin/cat ${fstab}.local | while read _device _mountpt _fs _mode _a _b; do

		[ -z "${_mountpt}" ] && continue

		case ":${_device}" in
			:#* | :)
			continue
			;;
			*)
				if [ "${_fs}" = "zfs" ]; then
					if [ ${allow_zfs} -ne 1 ]; then
						# allow_zfs not enabled, skipp
						continue
					fi
					# we need special route for jails with zfs attach, make sign for jstart script
					/usr/bin/touch ${with_zfs_attach}
					continue
				else
					echo "local_mpt${i}=\"${_mountpt}\""
					i=$(( i + 1 ))
				fi
			;;
		esac
	done )
}

# return 0 if no such mount point in fstab.local exist
# return 1 if exist
# $1 - test mpt
# example:
# if ! check_for_localmpt_fstab /tmp; then
#		echo "EXIST"
# fi
check_for_localmpt_fstab()
{
	local _res=0 i local_mpt

	[ -z "${1}" ] && return 0

	for i in $( /usr/bin/seq 0 128 ); do
		eval local_mpt="\$local_mpt${i}"
		[ -z "${local_mpt}" ] && break
		[ "${local_mpt}" = "${1}" ] && _res=1 && break
	done

	return ${_res}
}

## MAIN
# check for CRLF at the end of file
_ret=$( /usr/bin/tail -c1 "${fstab}" )

if [ -n "${_ret}" ]; then
	# append CRLF for proper while read loop
	printf '\n' >> "${fstab}"
fi

init_localmpt_fstab

# always rewrite CBSDROOT first
replacewdir file0="${fstab}" old="CBSDROOT"

# first pass: test for fstab is valid
/bin/cat ${fstab} | while read _device _mountpt _fs _mode _a _b; do

	case ":${_device}" in
		:#* | :)
		continue
		;;
	*)
		if [ "${_fs}" = "zfs" ]; then
			if [ ${allow_zfs} -ne 1 ]; then
				#${ECHO} "${W1_COLOR}Warning: ${N1_COLOR}fstab have zfs: ${N2_COLOR}${_device}${N1_COLOR}, but ${N2_COLOR}allow_zfs=0${N1_COLOR}. Please enable it.${N0_COLOR}"
				continue
			fi
			# we need special route for jails with zfs attach, make sign for jstart script
			/usr/bin/touch ${with_zfs_attach}
			continue
		fi

		if [ "${_fs}" = "geli" ]; then
			is_mounted ${gelidir} && continue
			err 1 "Error: ${gelidir} is not initializated. Please use: 'cbsd geli mode=initmaster' first"
		fi
		[ -z "${_device}" ] && continue
		# append workdir if it not full path
		prefix=$( substr --pos=0 --len=1 --str=${_device} )
		[ "${prefix}" != "/" ] && _device="${workdir}/${_device}"
		;;
	esac
done

/bin/cat ${fstab} | while read _device _mountpt _fs _mode _a _b; do
	[ "${_fs}" = "zfs" ] && continue
	case ":${_device}" in
		:#* | :)
		continue
		;;
	esac

	# SKIP mount when mount point also exist in fstab.local. fstab.local is preferred
	if [ ${have_local} -eq 1 ]; then
		if ! check_for_localmpt_fstab ${_mountpt}; then
			continue
		fi
	fi

	mnt=0
	prefix=$( substr --pos=0 --len=1 --str=${_device} )

	if [ "${_fs}" = "geli" ]; then
		# prepare src part
		if [ "${prefix}" != "/" ]; then
			if [ -z "${jname}" ]; then
				_device="${workdir}/${_device}"
			else
				_device="${jailsysdir}/${jname}/${_device}"
			fi
		fi
		attachgeli file="${_device}" dst="${jroot}${_mountpt}" mode="${_mode}"
		continue
	fi

	[ "${prefix}" != "/" ] && _device="${workdir}/${_device}"

	if is_mounted "${jroot}${_mountpt}"; then
		echo "${jroot}${_mountpt} already mounted"
		mnt=1
	fi

	[ ${mnt} -eq 1 ] && continue

	# /usr/compat - work-around for migrate from /usr/compat -> /compat introduced in CBSD 11.0.16
	[ "${_mountpt}" = "/usr/compat" ] && _mountpt="/compat"

	if [ ! -d "${jroot}${_mountpt}" ]; then
		/bin/mkdir -p "${jroot}${_mountpt}"
		_ret=$?
		if [ ${_ret} -ne 0 ]; then
			${ECHO} "${W1_COLOR}Warning: ${N1_COLOR}mountfstab: unable to create mountpoint for ${_fs} ${_device}: ${N2_COLOR}${jroot}${_mountpt}${N0_COLOR}"
			${ECHO} "${W1_COLOR}Warning: ${N1_COLOR}mountfstab: read-only location? Skip mount for ${jroot}${_mountpt}${N0_COLOR}"
			continue
		fi
	fi

	/sbin/mount -t ${_fs} -o${_mode} ${_device} ${jroot}${_mountpt}
done
