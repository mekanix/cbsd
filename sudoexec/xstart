#!/usr/local/bin/cbsd
#v12.0.5
MYARG=""
MYOPTARG="jname inter debug"
MYDESC="Start XEN domain"
ADDHELP="inter=0 to prevent any questions and to accept answers by default\n"
CBSDMODULE="xen"
EXTHELP="wf_jstop_jstart.html"

. ${subr}
. ${tools}		# for select_jail_by_list

readconf buildworld.conf
readconf jail-freebsd-default.conf

[ -z "${1}" ] && select_jail_by_list -s "List of offline VMs" -a "Off" -e xls -r ${sqlreplica}
. ${cbsdinit}

. ${system}
. ${distdir}/universe.subr
. ${distdir}/xen.subr
. ${distdir}/vnet.subr 		# get_vm_uplink_interface

[ -z "${jname}" -a -z "$*" ] && err 1 "${N1_COLOR}No domain specified${N0_COLOR}"

. ${distdir}/fetch.subr
. ${distdir}/jcreate.subr       # for external_exec_master_script
. ${distdir}/virtual.subr		# for init_systap

make_freebsd_part()
{
/bin/cat >> $1 << EOF
# $vm_os_type specific:
builder = "hvm"
serial="pty"
vncconsole=1
EOF
}

make_linux_part()
{
/bin/cat >> $1 << EOF

# $vm_os_type specific:
builder = "hvm"
#kernel = "/mnt/iso/isolinux/vmlinuz"
#ramdisk = "/mnt/iso/isolinux/initrd.img"
#extra = "debian-installer/exit/always_halt=true -- console=hvc0"
#sdl=1
serial='pty'
EOF
}

make_windows_part()
{
/bin/cat >> $1 << EOF

# $vm_os_type specific:
builder='hvm'
acpi = 1
EOF
}

make_other_part()
{
/bin/cat >> $1 << EOF

# $vm_os_type specific:
builder='hvm'
EOF
}

start_xen()
{
	local XENCFG
	local xvm_ram

	# profile
	readconf vm-${vm_os_type}-${vm_os_profile}.conf
	if [ -z "${vm_profile}" ]; then
		${ECHO} "${N1_COLOR}No such profile: ${N2_COLOR}vm-${vm_os_type}-${vm_os_profile}.conf${N0_COLOR}"
		sleep 2
	fi
	# re-read jail params and apply personal after profile
	. ${jrcconf}

	# CBSD QUEUE
	if [ -x "${moduledir}/cbsd_queue.d/cbsd_queue" ]; then
		[ "${cbsd_queue_name}" != "none" ] && cbsd_queue cbsd_queue_name=${cbsd_queue_name} id=${jname} cmd=xstart status=1
	fi

	vm_boot=$( cbsdsqlro ${main_sqlite_local} SELECT vm_boot FROM settings 2>/dev/null )
	manage_boot_by_empty_hdd

	if [ "${vm_boot}" = "cd" ]; then
		init_iso
		if [ $? -eq 1 ]; then
			printf "${N1_COLOR}Continue without ${iso_img}. Hope this is ok, sleep for 5 seconds ${N0_COLOR}"
				for i in $( /usr/bin/jot 5 ); do
					printf "."
					sleep 1
				done
				echo
		fi
	fi

	case "${vm_boot}" in
		"hdd")
			boot_arg='boot="c"'
			;;
		"cd")
			boot_arg='boot="d"'
			;;
	esac

	# for vnet we can make another action
	. ${vimageconf}

	#unset zero-value
	[ "${bhyve_flags}" = "0" ] && unset bhyve_flags
	[ "${vm_os_profile}" = "0" ] && unset vm_os_profile

#	if ! compile_dsk_args; then
#		${ECHO} "${N1_COLOR}No such disk for VMs: ${N2_COLOR}${jname}${N0_COLOR}"
#		unset dsk_args
#	fi

#	if ! compile_cd_args; then
#		unset cd_args
#	fi

	# init nic_args
	#if ! compile_nic_args ; then
	#	${ECHO} "${N1_COLOR}No such nic for VMs: ${N2_COLOR}${jname}${N0_COLOR}"
	#	unset nic_args
	#fi

	# init console_args
	#if ! compile_console_args; then
	#	${ECHO} "${N1_COLOR}No such console for VMs: ${N2_COLOR}${jname}${N0_COLOR}"
	#	unset console_args
	#fi

	# init vnc_args
	if ! compile_vnc_args ; then
		unset vnc_args
	fi

	# init vnc_args
	if ! compile_spice_args ; then
		unset vnc_spice
	fi

	xvm_ram=$(( vm_ram / 1024 / 1024  ))

	# Poehali!

	export_bhyve_data_for_external_hook
	external_exec_master_script "master_prestart.d"

	vm_logfile=$( /usr/bin/mktemp )

	XENCFG="${jailsysdir}/${jname}/xen.cfg"
	/usr/bin/truncate -s0 ${XENCFG}

	/bin/cat >> ${XENCFG} << EOF
name = "${jname}"
memory = ${xvm_ram}
vcpus = ${vm_cpus}

# Network devices
vif = [ 'bridge=bridge0' ]

# Boot args
${boot_arg}

#vnc = 1
#vnclisten = "${xen_vnc_tcp_bind}"
#vncpasswd="${vnc_password}"
#vncdisplay="${vncdisplay}"

# larger resolution
stdvga=1
videoram=16

#vm_vnc_port='${vm_vnc_port}'
opengl=1
vncconsole=1
vncunused=0

on_poweroff="${on_poweroff}";
on_reboot="${on_reboot}";
on_crash="${on_crash}";

# SPICE
#vnc=0
#on_crash="destroy"
#vga="stdvga"
#spice=1
#spicehost='0.0.0.0'
#spiceport=6000
# spicedisable_ticketing enabled is for no spice password, instead use spicepasswd
#spicedisable_ticketing=1
#spicepasswd="test"
#spicevdagent=1
#spice_clipboard_sharing=1
# this will automatically redirect up to 4 usb devices from spice client to domUs
#spiceusbredirection=4
# This adds intel hd audio emulated card used for spice audio
#soundhw="hda"
#localtime=1

EOF

	case ${spice_default} in
		0)
			/bin/cat >> ${XENCFG} <<EOF
vnc = 1
vnclisten = "${xen_vnc_tcp_bind}"
vncpasswd="${vnc_password}"
vncdisplay="${vncdisplay}"
EOF
			;;
		1)
			/bin/cat >> ${XENCFG} <<EOF
spice=1
spicehost="${xen_spice_tcp_bind}"
spiceport="${vncdisplay}"
spicepasswd="${spice_password}"
EOF
			;;
	esac

	if [ -n "${xen_soundhw}" -a "${xen_soundhw}" != "none" ]; then
		/bin/cat >> ${XENCFG} <<EOF
soundhw="${xen_soundhw}"
EOF
	fi

	if ! compile_dsk_args ${XENCFG}; then
		${ECHO} "${N1_COLOR}xstart: compile_dsk_args failed for vm: ${N2_COLOR}${jname}${N0_COLOR}"
		unset dsk_args
	fi

	case "${vm_os_type}" in
		"freebsd")
			make_freebsd_part ${XENCFG}
			;;
		"linux")
			make_linux_part ${XENCFG}
			;;
		"windows")
			make_windows_part ${XENCFG}
			;;
		*)
			make_other_part ${XENCFG}
			;;
	esac

	xl_cmd="${XL_CMD} -vvv create -c ${XENCFG}"
	echo "[debug]: $xl_cmd"
	#${tmuxcmd} -2 new -d -s "cbsd-${jname}" "eval ${xl_cmd}"

	${tmuxcmd} -2 -u new -d -s "cbsd-${jname}" "${xl_cmd}"

	external_exec_master_script "master_poststart.d"

	# CBSD QUEUE
	if [ -x "${moduledir}/cbsd_queue.d/cbsd_queue" ]; then
		[ "${cbsd_queue_name}" != "none" ] && cbsd_queue cbsd_queue_name=${cbsd_queue_name} id=${jname} cmd=xstart status=2 data_status=1
	fi

	[ -z "${vm_pid}" ] && vm_pid="0"

	echo

	${ECHO} "${N1_COLOR}PID: ${N2_COLOR}${vm_pid}${N0_COLOR}"
	cbsdsqlrw local "UPDATE jails SET jid=\"${vm_pid}\" WHERE jname=\"${jname}\""

	# update state_time
	cbsdsqlrw ${jailsysdir}/${jname}/local.sqlite UPDATE settings SET state_time="(strftime('%s','now'))"

	# update state_time, local SQLite for back compatible
	cbsdsqlrw local "UPDATE jails SET state_time=\"(strftime('%s','now'))\" WHERE jname=\"${jname}\""

	err 0 ""

}


# MAIN for multiple jails
TRAP=""
[ -z "${cbsd_queue_name}" ] && cbsd_queue_name="/clonos/xenvms/"

emulator="xen"        # for jname_is_multiple
jname_is_multiple

if [ $# -gt 1 -a -z "${jname}" -o -n "${jail_list}" ]; then
	# multiple astart always non interactive
	export inter=0
	# recursive
	if [ -n "${jail_list}" ]; then
		JLIST="${jail_list}"
	else
		JLIST=$*
	fi

	for jname in ${JLIST}; do
		[ "${jname}" = "inter=0" ] && continue
		TRAP="${TRAP} /bin/rm -f ${ftmpdir}/xstart.${jname}.$$;"
		trap "${TRAP}" HUP INT ABRT BUS TERM EXIT
		if [ -n "${cbsd_queue_name}" ]; then
			/usr/sbin/daemon -p ${ftmpdir}/xstart.${jname}.$$ /usr/local/bin/cbsd xstart inter=${inter} jname=${jname} cbsd_queue_name="${cbsd_queue_name}"
		else
			/usr/sbin/daemon -p ${ftmpdir}/xstart.${jname}.$$ /usr/local/bin/cbsd xstart inter=${inter} jname=${jname}
		fi
		#lets save .pid file
		sleep 1
		[ -f "${ftmpdir}/xstart.${jname}.$$" ] && cbsd_pwait --pid=$( /bin/cat ${ftmpdir}/xstart.${jname}.$$ ) --timeout=${parallel}
		trap "" HUP INT ABRT BUS TERM EXIT
		# Artificial delay to create a sequence (for order compliance)
		# todo: determine VM complete starting
		sleep 12
	done

	wait_for_fpid -a start -t ${parallel}

	err 0 "${N1_COLOR}Multiple bstart: ${N2_COLOR}done${N0_COLOR}"
fi

# MAIN
. ${distsharedir}/xen.conf		# only for for MYCOL variables: used in exports below

init_xen
init_systap

st_time=$( /bin/date +%s )
[ -z "$jname" ] && jname=$1

default_profile="xen-default-default.conf"
readconf vnc.conf
readconf spice.conf
readconf xstart.conf

readconf ${default_profile}

. ${jrcconf}
[ $? -eq 1 ] && err 1 "${N1_COLOR}No such domain: ${N2_COLOR}${jname}${N0_COLOR}"
[ ${status} -eq 2 ] && err 1 "${N1_COLOR}Domain in slave mode. Please ${N2_COLOR}cbsd jswmode mode=master${N1_COLOR} first${N0_COLOR}"

[ ${jid} -ne 0 ] && err 1 "${N1_COLOR}Jail ${jname} already running, jid: ${N2_COLOR}${jid}${N0_COLOR}"
[ "${emulator}" != "xen" ] && err 1 "${N1_COLOR}Not xen mode${N0_COLOR}"
[ -z "${vm_ram}" -o -z "${vm_cpus}" -o -z "${vm_os_type}" ] && err 1 "${N1_COLOR}Parameter is mandatory: ${N2_COLOR}vm_ram, vm_cpus, vm_os_type${N0_COLOR}"
[ -z "${iso_auto_fetch}" ] && iso_auto_fetch=0
[ -z "${debug}" ] && debug=0

main_sqlite_local="${jailsysdir}/${jname}/local.sqlite"

# hardcoded first disk path from SQL. Todo: mark bootable disk(s)
MDFILE=$( cbsdsqlro ${jailsysdir}/${jname}/local.sqlite SELECT dsk_path FROM xendsk WHERE jname=\"${jname}\" AND dsk_type=\"vhd\" LIMIT 1 2>/dev/null )

if [ -z "${MDFILE}" ]; then
	${ECHO} "${N1_COLOR}Warning: no any storage device found for this VM${N0_COLOR}"
else
	if [ ! -f "${data}/${MDFILE}" -a ! -h "${data}/${MDFILE}" ]; then
		${ECHO} "${N1_COLOR}No such ${data}/${MDFILE} but mdsize flags is not null.${N0_COLOR}"

		# if zfsfeat=1, try scan for zvol
		[ "${zfsfeat}" != "1" ] && break

		readconf zfs.conf
		. ${zfstool}
		DATA=$( /sbin/zfs get -Ho value name ${jaildatadir} 2>/dev/null )

		[ -z "${DATA}" ] && break

		for lunname in $( /usr/bin/seq 0 10 ); do
			if [ -r /dev/zvol/${DATA}/bcbsd-${jname}-dsk${lunname}.vhd ]; then
				/bin/ln -sf /dev/zvol/${DATA}/bcbsd-${jname}-dsk${lunname}.vhd ${data}/dsk${lunname}.vhd
				${ECHO} "${N1_COLOR}Found zvol and create symlink: ${data}/dsk${lunname}.vhd -> ${DATA}/bcbsd-${jname}-dsk${lunname}.vhd"
			fi
		done
	fi
fi

# export variables for external hooks
export jname=${jname}

for _i in ${JARG} ${MYCOL}; do
	T=
	eval T="\$$_i"
	export ${_i}="${T}"
done

# test for incorrect state
if [ ${status} -eq 3 ]; then
	cbsdsqlrw local UPDATE jails SET maintenance=\"${comment}\" WHERE jname=\"${jname}\"
	comment="cbsdsqlro local SELECT maintenance FROM jails WHERE jname=\"${jname}\""
	if [ "${comment}" = "Stopping_VM" ]; then
		jswmode jname=${jname} mode=master comment='0'
	else
		${ECHO} "${N1_COLOR}Xen in maintenance: ${N2_COLOR}${comment}${N0_COLOR}"
		err 1 "${N1_COLOR}Please finish maintenance and switch mode via: ${N2_COLOR}jswmode jname=${jname} mode=master comment='0'${N0_COLOR}"
	fi
fi

start_xen
end_time=$( /bin/date +%s )
cbsdlogger NOTICE ${CBSD_APP}: bhyve domain ${jname} started in $(( end_time - st_time ))s

exit 0
